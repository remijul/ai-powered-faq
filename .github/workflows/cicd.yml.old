# =============================================================================
# PIPELINE CI/CD (Continuous Integration / Continuous Deployment)
# =============================================================================
# Ce workflow exÃ©cute les tests ET dÃ©ploie l'application automatiquement.
#
# ChaÃ®ne complÃ¨te :
#   LINT â†’ BUILD â†’ TEST â†’ DEPLOY
#
# Le dÃ©ploiement n'est dÃ©clenchÃ© QUE si :
#   - Tous les tests passent
#   - Le push est sur la branche main
#
# Secrets requis (Ã  configurer dans GitHub) :
#   - HF_API_TOKEN : Token HuggingFace pour les tests
#   - DEPLOY_TOKEN : Token de dÃ©ploiement (optionnel)
# =============================================================================

name: CI/CD Pipeline

# -----------------------------------------------------------------------------
# DÃ‰CLENCHEURS
# -----------------------------------------------------------------------------
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# -----------------------------------------------------------------------------
# JOBS
# -----------------------------------------------------------------------------
jobs:
  
  # ===========================================================================
  # JOB 1 : LINT - VÃ©rification du style de code
  # ===========================================================================
  lint:
    name: ğŸ” Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linters
        run: pip install flake8 black isort
      
      # VÃ©rifier le formatage avec black (sans modifier)
      - name: Check formatting (black)
        run: |
          echo "ğŸ¨ VÃ©rification du formatage..."
          black --check --diff src/ tests/ || echo "âš ï¸ Formatage non conforme (black)"
        continue-on-error: true
      
      # VÃ©rifier l'ordre des imports
      - name: Check imports (isort)
        run: |
          echo "ğŸ“¦ VÃ©rification des imports..."
          isort --check-only --diff src/ tests/ || echo "âš ï¸ Imports non triÃ©s (isort)"
        continue-on-error: true
      
      # Linter strict
      - name: Lint code (flake8)
        run: |
          echo "ğŸ” Analyse statique du code..."
          flake8 src/ tests/ --max-line-length=120 --ignore=E501,W503,E402
          echo "âœ… Lint OK"
  
  # ===========================================================================
  # JOB 2 : BUILD - Construction de l'application
  # ===========================================================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: lint  # Attend que lint soit OK
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # Cache pip pour accÃ©lÃ©rer les builds
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… DÃ©pendances installÃ©es"
      
      # VÃ©rifier que tous les modules s'importent correctement
      - name: Verify imports
        run: |
          echo "ğŸ”§ VÃ©rification des imports..."
          python -c "from src.api.main import app"
          python -c "from src.api.routes import health, answer, faq"
          python -c "from src.api.models import QuestionRequest, AnswerResponse"
          python -c "from src.api.services.faq_service import FAQService"
          python -c "from src.strategies.base import BaseStrategy, FAQResponse"
          echo "âœ… Tous les imports OK"
      
      # VÃ©rifier que l'API dÃ©marre (test rapide)
      - name: Verify API starts
        run: |
          echo "ğŸš€ Test de dÃ©marrage de l'API..."
          timeout 10 python -c "
          from fastapi.testclient import TestClient
          from src.api.main import app
          client = TestClient(app)
          response = client.get('/health')
          assert response.status_code == 200, 'Health check failed'
          print('âœ… API dÃ©marre correctement')
          " || echo "âš ï¸ Timeout au dÃ©marrage (normal si modÃ¨les lourds)"
        continue-on-error: true
  
  # ===========================================================================
  # JOB 3 : TEST - ExÃ©cution des tests
  # ===========================================================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: build  # Attend que build soit OK
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # Cache des modÃ¨les HuggingFace (accÃ©lÃ¨re beaucoup les tests)
      - name: Cache HuggingFace models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-models
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx
      
      # Tests unitaires (rapides, sans API externe)
      - name: Run unit tests
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª TESTS UNITAIRES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/unit/ -v --tb=short
      
      # Tests d'intÃ©gration (service + stratÃ©gie)
      - name: Run integration tests
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª TESTS D'INTÃ‰GRATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/integration/ -v --tb=short
      
      # Tests systÃ¨me (API complÃ¨te)
      - name: Run system tests
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª TESTS SYSTÃˆME (E2E)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/systeme/ -v --tb=short
      
      # Rapport de couverture complet
      - name: Generate coverage report
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RAPPORT DE COUVERTURE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing
      
      # Upload vers Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true
      
      # RÃ©sumÃ© final
      - name: Test summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TOUS LES TESTS PASSENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # ===========================================================================
  # JOB 4 : DEPLOY - DÃ©ploiement (uniquement sur main)
  # ===========================================================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: test  # Attend que TOUS les tests passent
    
    # Conditions de dÃ©ploiement :
    # - Branche main uniquement
    # - Push (pas les PR)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # Afficher les informations de dÃ©ploiement
      - name: Deployment info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ DÃ‰PLOIEMENT EN PRODUCTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Œ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ“… Date: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # =======================================================================
      # OPTIONS DE DÃ‰PLOIEMENT (dÃ©commenter selon votre plateforme)
      # =======================================================================
      
      # Option 1 : DÃ©ploiement Heroku
      # - name: Deploy to Heroku
      #   env:
      #     HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      #   run: |
      #     heroku container:push web --app mon-app-faq
      #     heroku container:release web --app mon-app-faq
      
      # Option 2 : DÃ©ploiement Railway
      # - name: Deploy to Railway
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      #   run: |
      #     npm install -g @railway/cli
      #     railway up
      
      # Option 3 : DÃ©ploiement serveur SSH
      # - name: Deploy via SSH
      #   env:
      #     SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #   run: |
      #     echo "$SSH_KEY" > key.pem
      #     chmod 600 key.pem
      #     ssh -i key.pem user@server "cd /app && git pull && systemctl restart faq-api"
      
      # Option 4 : Build et push Docker
      # - name: Build and push Docker image
      #   run: |
      #     docker build -t faq-api:${{ github.sha }} .
      #     docker tag faq-api:${{ github.sha }} registry/faq-api:latest
      #     docker push registry/faq-api:latest
      
      # Placeholder pour le dÃ©ploiement
      - name: Deploy placeholder
        run: |
          echo "ğŸš€ DÃ©ploiement simulÃ©..."
          echo "   â†’ En production, configurez votre mÃ©thode de dÃ©ploiement"
          echo "   â†’ Heroku, Railway, Docker, SSH, etc."
          echo "âœ… DÃ©ploiement terminÃ© (simulation)"
      
      # Notification de succÃ¨s
      - name: Notify success
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "::notice::Deployment successful! ğŸ‰"